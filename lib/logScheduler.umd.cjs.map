{"version":3,"file":"logScheduler.umd.cjs","sources":["../src/proxy/index.ts","../src/handler/index.ts","../src/queue/base.ts","../src/queue/request.ts","../src/queue/log.ts","../src/queue/index.ts","../src/options/default.ts","../src/main.ts"],"sourcesContent":["export const rowImage=Image\nlet tag=false\n  // 重写原生的Image对象，做到监控项目中所有的打点\nexport function overrideImage(callback:(arg0:string)=>boolean){\n    if(tag){return}\n    tag=true\n    window.Image = function (width?:number|undefined,height?:number|undefined,) {\n      const img = new rowImage(width,height);\n      // 劫持对象中的src，当重设src时判断是否是打点请求\n      let proxy = new Proxy(img, {\n        get(target,prototype,receiver){\n            return Reflect.get(target, prototype, receiver)\n        },\n        set(target,prototype,value,receiver){\n          if(prototype=='src'){\n           if(callback(value)){\n            //当为打点信息时，走拦截器逻辑并在此处阻止打点请求\n              target[prototype]=''\n              return true\n           }\n          }\n          \n          return Reflect.set(target, prototype, value, receiver)\n        }\n      })\n      return proxy\n    } as unknown as new (width?: number | undefined, height?: number | undefined)=> HTMLImageElement\n  }\n","export default class RequestHandler {\n  // 对xhr进行重写，获取正在请求的xhr数目\n  interceptor\n  constructor(interceptor:Interceptor) {\n    this.interceptor=interceptor\n     this.setRequestHandler();\n     this.setResponseHandler();\n  }\n  //劫持xhr，在每次请求时出发请求拦截器\n  setRequestHandler() {\n    const { open } = XMLHttpRequest.prototype;\n    const vm=this\n    XMLHttpRequest.prototype.open = function (this:any,method, url, async, user, password) {\n      vm.interceptor.request(url)\n      open.call(this, method,url,async,user,password);\n    } as { \n      (method: string, url: string | URL): void;\n      (method: string, url: string | URL, async: boolean, username?: string | null | undefined, password?: string | null | undefined): void;\n        }\n  }\n  // 对请求和图片请求成功的毁掉添加响应拦截，避免劫持xhr响应回掉时跟其他SDK的冲突\n  setResponseHandler(){\n    const vm=this\n    let observer = new PerformanceObserver(function (entries) {\n      entries.getEntries().forEach((entry) => {\n        console.log('23')\n          if(['img','xmlhttprequest'].includes((entry as PerformanceEntryResource).initiatorType)){\n            vm.interceptor.response(entry.name)\n          }\n      });\n    });\n    observer.observe({ entryTypes: ['resource'] });\n  }\n}\n","//队列基类\nexport default class BaseList{\n    list:string[]=[]\n    constructor(){\n    }\n    add(item:string){\n      this.list.push(item)\n    }\n    delete(deletedItem:string){\n      const deletedIndex=this.list.findIndex(item=>item==deletedItem)\n      deletedIndex!=-1 && this.list.splice(deletedIndex,1)\n    }\n    getLength(){\n      return this.list.length\n    }\n    clear(){\n       while(this.list.length){\n        this.list.pop()\n       }\n    }\n  }","import BaseList from './base'\n//设置节点变动监控，当变化时查找新的图片请求\nfunction setImageDomObserve(callback:()=>void){\n    let targetNode = document.querySelector(\"body\")||document.createElement('div');\n    let observerOptions = {\n      childList: true, \n      attributes: true, \n      subtree: true    \n    }\n    let observer = new MutationObserver(callback);\n    observer.observe(targetNode, observerOptions);\n  }\n  \n  // 请求队列\n  export default class RequestList extends BaseList {\n    constructor() {\n      super()\n      setImageDomObserve(this.getCurrentImageResquest.bind(this))\n    }\n    // 这里增加异步操作，考虑请求连续增长的问题\n    async getLengthAsync(): Promise<number>{\n      return new Promise((reslove)=>{\n          setTimeout(()=>{\n            reslove(this.getLength())\n          },0)\n      })\n    }\n    // 查找出目前正在发生的图片请求\n    getCurrentImageResquest(){\n       const imageList=Array.from(document.querySelectorAll('img[src]')) as HTMLImageElement[]\n       imageList.filter(img=>!img.complete).forEach(img=>{\n            this.add(img.currentSrc)\n            // 由于perfromceObsever无法检测到加载失败，因此需要手动增加监听器出队列\n            img.addEventListener('error',()=>{\n              this.delete(img.currentSrc)\n            })\n       })\n    }\n  }","import BaseList from './base'\nimport { rowImage } from '../proxy'\n//打点队列\nexport default class LogList extends BaseList{\n    options:Options;\n    getCurrentRequestFn:()=>Promise<number>;\n    constructor(options:Options){\n      super()\n      this.options=options;\n    }\n    async add(item: string): Promise<void>{\n      this.list.push(item) \n      // 当前本身就是空置时直接触发\n      if(await this.getCurrentRequestFn()<=this.options.trigger){\n          this.requestLog()\n      }\n    }\n    // 获取请求数目的接口\n    getCurrentRequestImpl(getCurrentRequestFn:()=>Promise<number>){\n       this.getCurrentRequestFn=getCurrentRequestFn\n    }\n    // 判断是否是log\n    isLogger(url:url):boolean {\n      const logReg=new RegExp(this.options.log)\n      if (typeof url !== 'string') {\n        return false;\n      }\n      if (logReg.test(url)) {\n        return true;\n      }\n      return false;\n    }\n     async requestLog(){\n      this.list.forEach(url=>{\n        imagePromiseFactory(url)\n      })\n      this.clear()\n      }\n  }\n\n  function imagePromiseFactory(url:string){\n    return new Promise<any>((reslove)=>{\n      const img=new rowImage()\n      img.src=url\n      img.onload=function(){\n        reslove(url)\n      }\n      img.onerror=function(){\n        reslove(url)\n      }\n  })\n  }","import RequestList from './request'\nimport LogList from './log'\nlet request:RequestList|null=null\nlet log:LogList|null=null\n//这里工厂+单例，方便后期动态修改或添加配置\nexport function requestListFactory():RequestList{\n    if(!request){\n      return new RequestList()\n    }\n    return request\n}\nexport function logListFactory(options:Options):LogList{\n   if(!log){\n    return new LogList(options)\n   }\n   return log\n}\n// 解耦工具类，将主类和队列类进行解耦\nexport class InterceptorIOCTool{\n  requestList:RequestList\n  logList:LogList\n  constructor(requestList:RequestList,logList:LogList){\n      this.requestList=requestList\n      this.logList=logList\n      this.logList.getCurrentRequestImpl(this.getCurrentRequest.bind(this))\n  }\n  getCurrentRequest(){\n     return this.requestList.getLengthAsync()\n  }\n  createRequestInterceptor(){\n    const vm=this\n    return function(url:url){\n      if(vm.logList.isLogger(url)){\n        vm.logList.add(url.toString())\n        return true\n      }\n      vm.requestList.add(url.toString())\n      return false\n    }\n  }\n  createResponseInterceptor(options:Options){\n    const vm=this\n    return async function(url:string | URL){\n      if(!vm.logList.isLogger(url)){\n        vm.requestList.delete(url.toString())\n      } else{\n        // 如果是log,直接返回，防止递归死循环\n        return false\n      }\n      if(await vm.requestList.getLengthAsync()<=options.trigger){\n          vm.logList.requestLog()\n      }\n      return true\n    }\n  }\n}\n","// 默认配置对象\nconst defaultOptions={ \n    max:5,  \n    trigger:3,\n    log:/log.gif/\n}\n\nexport function mergeOptions(userOptions:Options){\n    // 目前直接合并，之后如果有数组和对象配置需要考虑扩展\n   return Object.assign(defaultOptions,userOptions)\n}","import {overrideImage} from './proxy';\nimport RequestHandler from './handler';\nimport {requestListFactory,logListFactory} from './queue/index'\nimport {InterceptorIOCTool} from './queue/index'\nimport {mergeOptions} from './options/default'\nimport RequestList from './queue/request';\nimport LogList from './queue/log';\nexport default class logScheduler {\n  options:Options;\n  requestHandler:RequestHandler;\n  requestList:RequestList;\n  logList:LogList;\n  interceptor:Interceptor={\n    request:()=>{return true},\n    response:()=>{return new Promise((reslove)=>{reslove(true)})}\n  };\n  constructor(options:any) {\n    this.options=mergeOptions(options)\n    this.initRequestQueue()\n    this.initInterceptor()\n    this.initObserver();\n  }\n  // 初始化图片劫持和请求观测\n  initObserver() {\n    overrideImage(this.interceptor.request)\n    this.requestHandler = new RequestHandler(this.interceptor);\n  }\n  // 初始化请求队列和打点队列\n  initRequestQueue(){\n      this.requestList=requestListFactory()\n      this.logList=logListFactory(this.options)\n  }\n  // 初始化拦截器\n  initInterceptor(){\n      const interceptorIOCTool=new InterceptorIOCTool(\n        this.requestList,this.logList\n      )\n      this.interceptor.request=interceptorIOCTool.createRequestInterceptor()\n      this.interceptor.response=interceptorIOCTool.createResponseInterceptor(this.options)\n  }\n}\n"],"names":["rowImage","tag","overrideImage","callback","width","height","img","target","prototype","receiver","value","RequestHandler","interceptor","__publicField","open","vm","method","url","async","user","password","entries","entry","BaseList","item","deletedItem","deletedIndex","setImageDomObserve","targetNode","observerOptions","RequestList","reslove","LogList","options","getCurrentRequestFn","logReg","imagePromiseFactory","requestListFactory","logListFactory","InterceptorIOCTool","requestList","logList","defaultOptions","mergeOptions","userOptions","logScheduler","interceptorIOCTool"],"mappings":"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"}