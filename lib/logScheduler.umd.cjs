(function(n,s){typeof exports=="object"&&typeof module<"u"?module.exports=s():typeof define=="function"&&define.amd?define(s):(n=typeof globalThis<"u"?globalThis:n||self,n.logScheduler=s())})(this,function(){"use strict";var I=Object.defineProperty;var w=(n,s,c)=>s in n?I(n,s,{enumerable:!0,configurable:!0,writable:!0,value:c}):n[s]=c;var u=(n,s,c)=>(w(n,typeof s!="symbol"?s+"":s,c),c);const n=Image;let s=!1;function c(i){s||(s=!0,window.Image=function(e,t){const r=new n(e,t);return new Proxy(r,{get(o,l,p){return Reflect.get(o,l,p)},set(o,l,p,h){return l=="src"&&i(p)?(o[l]="",!0):Reflect.set(o,l,p,h)}})})}class g{constructor(e={}){this.interceptor=e,this.setRequestHandler(),this.setResponseHandler()}setRequestHandler(){const{open:e,send:t}=XMLHttpRequest.prototype,r=this;XMLHttpRequest.prototype.open=function(a,o,l,p,h){r.interceptor.request(o),e.apply(this,arguments)}}setResponseHandler(){const e=this;new PerformanceObserver(function(r,a){r.getEntries().forEach(o=>{["img","xmlhttprequest"].includes(o.initiatorType)&&e.interceptor.response(o.name)})}).observe({entryTypes:["resource"]})}}class d{constructor(){u(this,"list",[])}add(e){this.list.push(e)}delete(e){const t=this.list.findIndex(r=>r==e);t!=-1&&this.list.splice(t,1)}getLength(){return this.list.length}clear(){for(;this.list.length;)this.list.pop()}}function f(i){let e=document.querySelector("body")||document.createElement("div"),t={childList:!0,attributes:!0,subtree:!0};new MutationObserver(i).observe(e,t)}class L extends d{constructor(){super(),f(this.getCurrentImageResquest.bind(this))}getCurrentImageResquest(){Array.from(document.querySelectorAll("img[src]")).filter(t=>!t.complete).forEach(t=>{this.add(t.currentSrc),t.addEventListener("error",()=>{this.delete(t.currentSrc)})})}}class m extends d{constructor(t={}){super();u(this,"options");this.options=t}isLogger(t){const r=new RegExp(this.options.log||/.gif/);return typeof t!="string"?!1:!!r.test(t)}async requestLog(){const t=this.list.map(r=>new Promise(a=>{const o=new n;o.src=r,a(r)}));await Promise.all(t)}}function q(){return new L}function R(i){return new m(i)}class v{constructor(e,t){u(this,"requestList");u(this,"logList");this.requestList=e,this.logList=t}createRequestInterceptor(){const e=this;return function(t){return e.logList.isLogger(t)?(e.logList.add(t),!0):(e.requestList.add(t),!1)}}createResponseInterceptor(){const e=this;return function(t){if(!e.logList.isLogger(t))e.requestList.delete(t);else return!1;return e.requestList.getLength()==0&&e.logList.requestLog(),!0}}}class b{constructor(e){u(this,"options");u(this,"requestHandler");u(this,"requestList");u(this,"logList");u(this,"interceptor",{request:null,response:null});this.options=e,this.initRequestQueue(),this.initInterceptor(),this.initObserver()}initObserver(){c(this.interceptor.request),this.requestHandler=new g(this.interceptor)}initRequestQueue(){this.requestList=q(),this.logList=R(this.options)}initInterceptor(){const e=new v(this.requestList,this.logList);this.interceptor.request=e.createRequestInterceptor(),this.interceptor.response=e.createResponseInterceptor()}}return b});
//# sourceMappingURL=logScheduler.umd.cjs.map
