(function(o,n){typeof exports=="object"&&typeof module<"u"?module.exports=n():typeof define=="function"&&define.amd?define(n):(o=typeof globalThis<"u"?globalThis:o||self,o.logScheduler=n())})(this,function(){"use strict";var x=Object.defineProperty;var O=(o,n,g)=>n in o?x(o,n,{enumerable:!0,configurable:!0,writable:!0,value:g}):o[n]=g;var l=(o,n,g)=>(O(o,typeof n!="symbol"?n+"":n,g),g);const o=Image;let n=!1;function g(r){n||(n=!0,window.Image=function(t,e){const s=new o(t,e);return new Proxy(s,{get(i,c,a){return Reflect.get(i,c,a)},set(i,c,a,y){return c=="src"&&r(a)?(i[c]="",!0):Reflect.set(i,c,a,y)}})})}class h{constructor(t){l(this,"interceptor");this.interceptor=t,this.setRequestHandler(),this.setResponseHandler()}setRequestHandler(){const{open:t}=XMLHttpRequest.prototype,e=this;XMLHttpRequest.prototype.open=function(s,u,i,c,a){e.interceptor.request(u),t.call(this,s,u,i,c,a)}}setResponseHandler(){const t=this;new PerformanceObserver(function(s){s.getEntries().forEach(u=>{["img","xmlhttprequest"].includes(u.initiatorType)&&t.interceptor.response(u.name)})}).observe({entryTypes:["resource"]})}}class p{constructor(){l(this,"list",[])}add(t){this.list.push(t)}delete(t){const e=this.list.findIndex(s=>s==t);e!=-1&&this.list.splice(e,1)}getLength(){return this.list.length}clear(){for(;this.list.length;)this.list.pop()}}function f(r){let t=document.querySelector("body")||document.createElement("div"),e={childList:!0,attributes:!0,subtree:!0};new MutationObserver(r).observe(t,e)}class d extends p{constructor(){super(),f(this.getCurrentImageResquest.bind(this))}getCurrentImageResquest(){Array.from(document.querySelectorAll("img[src]")).filter(e=>!e.complete).forEach(e=>{this.add(e.currentSrc),e.addEventListener("error",()=>{this.delete(e.currentSrc)})})}}function L(r,t){let e=0;return new Promise(function(s){for(;e<t;)u();function u(){if(e==r.length){s(e);return}r[e].finally(()=>{e++,u()})}})}class m extends p{constructor(e={}){super();l(this,"options");this.options=e}isLogger(e){const s=new RegExp(this.options.log);return typeof e!="string"?!1:!!s.test(e)}async requestLog(){const e=this.list.map(s=>new Promise(u=>{const i=new o;i.src=s,i.onload=function(c){i.onload&&i.onload(c),u(s)},i.onerror=function(c){i.onerror&&i.onerror(c),u(s)}}));await L(e,this.options.max)}}function q(){return new d}function R(r){return new m(r)}class b{constructor(t,e){l(this,"requestList");l(this,"logList");this.requestList=t,this.logList=e}createRequestInterceptor(){const t=this;return function(e){return t.logList.isLogger(e)?(t.logList.add(e.toString()),!0):(t.requestList.add(e.toString()),!1)}}createResponseInterceptor(t){const e=this;return function(s){if(!e.logList.isLogger(s))e.requestList.delete(s.toString());else return!1;return e.requestList.getLength()<=t.trigger&&e.logList.requestLog(),!0}}}const w={max:5,trigger:3,log:/log.gif/};function I(r){return Object.assign(w,r)}class v{constructor(t){l(this,"options");l(this,"requestHandler");l(this,"requestList");l(this,"logList");l(this,"interceptor");this.options=I(t),this.initRequestQueue(),this.initInterceptor(),this.initObserver()}initObserver(){g(this.interceptor.request),this.requestHandler=new h(this.interceptor)}initRequestQueue(){this.requestList=q(),this.logList=R(this.options)}initInterceptor(){const t=new b(this.requestList,this.logList);this.interceptor.request=t.createRequestInterceptor(),this.interceptor.response=t.createResponseInterceptor(this.options)}}return v});
//# sourceMappingURL=logScheduler.umd.cjs.map
