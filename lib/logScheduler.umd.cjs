(function(r,s){typeof exports=="object"&&typeof module<"u"?module.exports=s():typeof define=="function"&&define.amd?define(s):(r=typeof globalThis<"u"?globalThis:r||self,r.logScheduler=s())})(this,function(){"use strict";var b=Object.defineProperty;var I=(r,s,l)=>s in r?b(r,s,{enumerable:!0,configurable:!0,writable:!0,value:l}):r[s]=l;var u=(r,s,l)=>(I(r,typeof s!="symbol"?s+"":s,l),l);const r=Image;let s=!1;function l(o){s||(s=!0,window.Image=function(...e){const t=new r(...e);return new Proxy(t,{get(c,i){return c[i]},set(c,i,p){return i=="src"&&o(p)?(c[i]="",!0):(c[i]=p,!0)}})})}class d{constructor(e={}){this.interceptor=e,this.setRequestHandler(),this.setResponseHandler()}setRequestHandler(){const{open:e,send:t}=XMLHttpRequest.prototype,n=this;XMLHttpRequest.prototype.open=function(c,i,p,R,w){n.interceptor.request(i),e.apply(this,arguments)}}setResponseHandler(){const e=this;new PerformanceObserver(function(n,c){n.getEntries().forEach(i=>{["img","xmlhttprequest"].includes(i.initiatorType)&&e.interceptor.response(i.name)})}).observe({entryTypes:["resource"]})}}class a{constructor(){u(this,"list",[])}add(e){this.list.push(e)}delete(e){const t=this.list.findIndex(n=>n==e);t!=-1&&this.list.splice(t,1)}getLength(){return this.list.length}clear(){for(;this.list.length;)this.list.pop()}}function h(o){let e=document.querySelector("body")||document.createElement("div"),t={childList:!0,attributes:!0,subtree:!0};new MutationObserver(o).observe(e,t)}class g extends a{constructor(){super(),h(this.getCurrentImageResquest.bind(this))}getCurrentImageResquest(){Array.from(document.querySelectorAll("img[src]")).filter(t=>!t.complete).forEach(t=>{this.add(t.currentSrc),t.addEventListener("error",()=>{this.delete(t.currentSrc)})})}}class f extends a{constructor(t={}){super();u(this,"options");this.options=t}isLogger(t){const n=new RegExp(this.options.log||/.gif/);return typeof t!="string"?!1:!!n.test(t)}async requestLog(){const t=this.list.map(n=>new Promise(c=>{const i=new r;i.src=n,c(n)}));await Promise.all(t)}}function L(){return new g}function m(o){return new f(o)}class q{constructor(e,t){u(this,"requestList");u(this,"logList");this.requestList=e,this.logList=t}createRequestInterceptor(){const e=this;return function(t){return e.logList.isLogger(t)?(e.logList.add(t),!0):(e.requestList.add(t),!1)}}createResponseInterceptor(){const e=this;return function(t){if(!e.logList.isLogger(t))e.requestList.delete(t);else return!1;return e.requestList.getLength()==0&&e.logList.requestLog(),!0}}}class v{constructor(e){u(this,"options");u(this,"requestHandler");u(this,"requestList");u(this,"logList");u(this,"interceptor",{request:null,response:null});this.options=e,this.initRequestQueue(),this.initInterceptor(),this.initObserver()}initObserver(){l(this.interceptor.request),this.requestHandler=new d(this.interceptor)}initRequestQueue(){this.requestList=L(),this.logList=m(this.options)}initInterceptor(){const e=new q(this.requestList,this.logList);this.interceptor.request=e.createRequestInterceptor(),this.interceptor.response=e.createResponseInterceptor()}}return v});
//# sourceMappingURL=logScheduler.umd.cjs.map
