(function(u,o){typeof exports=="object"&&typeof module<"u"?module.exports=o():typeof define=="function"&&define.amd?define(o):(u=typeof globalThis<"u"?globalThis:u||self,u.logScheduler=o())})(this,function(){"use strict";var E=Object.defineProperty;var I=(u,o,l)=>o in u?E(u,o,{enumerable:!0,configurable:!0,writable:!0,value:l}):u[o]=l;var n=(u,o,l)=>(I(u,typeof o!="symbol"?o+"":o,l),l);const u=Image;let o=!1;function l(s){o||(o=!0,window.Image=function(e,t){const r=new u(e,t);return new Proxy(r,{get(c,g,h){return Reflect.get(c,g,h)},set(c,g,h,d){return g=="src"&&s(h,"image")?(c[g]="",!0):Reflect.set(c,g,h,d)}})})}class f{constructor(){n(this,"list",[])}add(e){this.list.push(e)}delete(e){const t=this.list.findIndex(r=>r==e);t!=-1&&this.list.splice(t,1)}getLength(){return this.list.length}includes(e){return this.list.includes(e)}clear(){for(;this.list.length;)this.list.pop()}}function q(s){let e=document.querySelector("body")||document.createElement("div"),t={childList:!0,attributes:!0,subtree:!0};new MutationObserver(s).observe(e,t)}class m extends f{constructor(){super(),q(this.getCurrentImageResquest.bind(this))}async getLengthAsync(){return new Promise(e=>{setTimeout(()=>{e(this.getLength())},0)})}getCurrentImageResquest(){Array.from(document.querySelectorAll("img[src]")).filter(t=>!t.complete).forEach(t=>{this.add(t.currentSrc)})}}class R extends f{constructor(t){super();n(this,"options");n(this,"getCurrentRequestFn");this.options=t}async add(t){this.list.push(t),await this.getCurrentRequestFn()<=this.options.trigger&&this.requestLog()}getCurrentRequestImpl(t){this.getCurrentRequestFn=t}isLogger(t){const r=this.options.log.map(i=>new RegExp(i));return typeof t!="string"?!1:!!r.some(i=>i.test(t))}async requestLog(){this.list.map(t=>{switch(this.delete(t),t.type){case"xhr":{y(t);break}case"image":{w(t.url);break}}})}}function y(s){return new Promise(e=>{try{const t=s.instance;t.addEventListener("load",function(){t.readyState==4&&t.status==200&&e(s.url)}),t.addEventListener("error",function(){e(s.url)}),s.instance.send(s.data)}catch{}})}function w(s){return new Promise(e=>{const t=new u;t.src=s,t.onload=function(){e(s)},t.onerror=function(){e(s)}})}function v(){return new m}function x(s){return new R(s)}function L(s,e,t,r){return{url:s.toString(),type:e,instance:t,data:r}}class A{constructor(e,t){n(this,"requestList");n(this,"logList");this.requestList=e,this.logList=t,this.logList.getCurrentRequestImpl(this.getCurrentRequest.bind(this))}getCurrentRequest(){return this.requestList.getLengthAsync()}createRequestInterceptor(){const e=this;return function(t,r){const i=L(t,r);return e.logList.isLogger(t)?(e.logList.add(i),!0):(e.requestList.add(t.toString()),!1)}}createResponseInterceptor(e){const t=this;return async function(r){if(!t.logList.isLogger(r))t.requestList.delete(r.toString());else return!1;return await t.requestList.getLengthAsync()<=e.trigger&&t.logList.requestLog(),!0}}}class O{constructor(e,t){n(this,"interceptor");n(this,"requestAbleList");this.interceptor=e,this.requestAbleList=t,this.setRequestHandler(),this.setResponseHandler()}setRequestHandler(){const{open:e,send:t}=XMLHttpRequest.prototype,r=this;XMLHttpRequest.prototype.open=function(i,c,g,h,d){r.interceptor.request(c,"xhr"),e.call(this,i,c,g,h,d)},XMLHttpRequest.prototype.send=function(i){if(r.requestAbleList.include(this.responseURL)){r.requestAbleList.add(this.responseURL,this,i);return}t.call(this,i)}}setResponseHandler(){const e=this;new PerformanceObserver(function(r){r.getEntries().forEach(i=>{["img","xmlhttprequest"].includes(i.initiatorType)&&e.interceptor.response(i.name)})}).observe({entryTypes:["resource"]})}}class b{constructor(e){n(this,"requestAbleList");n(this,"logList");this.logList=e}include(e){return this.logList.list.find(t=>t.url===e)}add(e,t,r){this.logList.add(L(e,"xhr",t,r))}}function a(s,e){return Object.prototype.toString.call(e)===`[object ${s}]`}function p(s,e=new WeakMap){if(typeof s!="object"||s===null)return s;if(a("Symbol",s))return s.constructor(s.description);if(e.has(s))return e.get(s);let t,r;if((a("Date",s)||a("RegExp",s))&&(r=s),t=new s.constructor(r),(a("Array",s)||a("Object",s))&&Object.keys(s).forEach(i=>{s.hasOwnProperty(i)&&(t[i]=p(s[i],e))}),a("Set",s))for(let i of s)t.add(p(i,e));if(a("Map",s))for(let[i,c]of s)t.set(p(i,e),p(c,e));return e.set(s,t),t}const C={max:5,trigger:3,log:[]};function S(s){const e=p(C);return Object.keys(e).forEach(t=>{Array.isArray(e[t])?Array.isArray(s[t])?e[t]=e[t].concat(s[t]):s[t]&&e[t].push(s[t]):e[t]=s[t]?s[t]:e[t]}),e.log=e.log.filter(t=>t),e}class T{constructor(e){n(this,"options");n(this,"requestList");n(this,"logList");n(this,"interceptorIOCTool");n(this,"interceptor",{request:()=>!0,response:()=>new Promise(e=>{e(!0)})});this.options=S(e),this.initRequestQueue(),this.initInterceptor(),this.initObserver()}initObserver(){l(this.interceptor.request),new O(this.interceptor,new b(this.logList))}initRequestQueue(){this.requestList=v(),this.logList=x(this.options)}initInterceptor(){this.interceptorIOCTool=new A(this.requestList,this.logList),this.interceptor.request=this.interceptorIOCTool.createRequestInterceptor(),this.interceptor.response=this.interceptorIOCTool.createResponseInterceptor(this.options)}}return T});
//# sourceMappingURL=logScheduler.umd.cjs.map
