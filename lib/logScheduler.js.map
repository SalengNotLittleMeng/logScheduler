{"version":3,"file":"logScheduler.js","sources":["../src/proxy/index.ts","../src/handler/index.ts","../src/queue/base.ts","../src/queue/request.ts","../src/queue/log.ts","../src/queue/index.ts","../src/options/default.ts","../src/main.ts"],"sourcesContent":["export const rowImage=Image\nlet tag=false\n  // 重写原生的Image对象，做到监控项目中所有的打点\nexport function overrideImage(callback:(arg0:string)=>boolean){\n    if(tag){return}\n    tag=true\n    window.Image = function (width?:number|undefined,height?:number|undefined,) {\n      const img = new rowImage(width,height);\n      // 劫持对象中的src，当重设src时判断是否是打点请求\n      let proxy = new Proxy(img, {\n        get(target,prototype,receiver){\n            return Reflect.get(target, prototype, receiver)\n        },\n        set(target,prototype,value,receiver){\n          if(prototype=='src'){\n           if(callback(value)){\n            //当为打点信息时，走拦截器逻辑并在此处阻止打点请求\n              target[prototype]=''\n              return true\n           }\n          }\n          \n          return Reflect.set(target, prototype, value, receiver)\n        }\n      })\n      return proxy\n    } as unknown as new (width?: number | undefined, height?: number | undefined)=> HTMLImageElement\n  }\n","export default class RequestHandler {\n  // 对xhr进行重写，获取正在请求的xhr数目\n  interceptor\n  constructor(interceptor:Interceptor) {\n    this.interceptor=interceptor\n     this.setRequestHandler();\n     this.setResponseHandler();\n  }\n  //劫持xhr，在每次请求时出发请求拦截器\n  setRequestHandler() {\n    const { open } = XMLHttpRequest.prototype;\n    const vm=this\n    XMLHttpRequest.prototype.open = function (this:any,method, url, async, user, password) {\n      vm.interceptor.request(url)\n      open.call(this, method,url,async,user,password);\n    } as { \n      (method: string, url: string | URL): void;\n      (method: string, url: string | URL, async: boolean, username?: string | null | undefined, password?: string | null | undefined): void;\n        }\n  }\n  // 对请求和图片请求成功的毁掉添加响应拦截，避免劫持xhr响应回掉时跟其他SDK的冲突\n  setResponseHandler(){\n    const vm=this\n    let observer = new PerformanceObserver(function (entries) {\n      entries.getEntries().forEach((entry) => {\n          if(['img','xmlhttprequest'].includes((entry as PerformanceEntryResource).initiatorType)){\n            vm.interceptor.response(entry.name)\n          }\n      });\n    });\n    observer.observe({ entryTypes: ['resource'] });\n  }\n}\n","//队列基类\nexport default class BaseList{\n    list:string[]=[]\n    constructor(){\n    }\n    add(item:string){\n      this.list.push(item)\n    }\n    delete(deletedItem:string){\n      const deletedIndex=this.list.findIndex(item=>item==deletedItem)\n      deletedIndex!=-1 && this.list.splice(deletedIndex,1)\n    }\n    getLength(){\n      return this.list.length\n    }\n    clear(){\n       while(this.list.length){\n        this.list.pop()\n       }\n    }\n  }","import BaseList from './base'\n//设置节点变动监控，当变化时查找新的图片请求\nfunction setImageDomObserve(callback:()=>void){\n    let targetNode = document.querySelector(\"body\")||document.createElement('div');\n    let observerOptions = {\n      childList: true, \n      attributes: true, \n      subtree: true    \n    }\n    let observer = new MutationObserver(callback);\n    observer.observe(targetNode, observerOptions);\n  }\n  \n  // 请求队列\n  export default class RequestList extends BaseList {\n    constructor() {\n      super()\n      setImageDomObserve(this.getCurrentImageResquest.bind(this))\n    }\n    // 查找出目前正在发生的图片请求\n    getCurrentImageResquest(){\n       const imageList=Array.from(document.querySelectorAll('img[src]')) as HTMLImageElement[]\n       imageList.filter(img=>!img.complete).forEach(img=>{\n            this.add(img.currentSrc)\n            img.addEventListener('error',()=>{\n              this.delete(img.currentSrc)\n            })\n       })\n    }\n  }","import BaseList from './base'\nimport { rowImage } from '../proxy'\n//打点队列\nexport default class LogList extends BaseList{\n    options:any\n    constructor(options={}){\n      super()\n      this.options=options\n    }\n    // 判断是否是log\n    isLogger(url:url):boolean {\n      const logReg=new RegExp(this.options.log)\n      if (typeof url !== 'string') {\n        return false;\n      }\n      if (logReg.test(url)) {\n        return true;\n      }\n      return false;\n    }\n     async requestLog(){\n        const requestList=this.list.map(url=>{\n          return new Promise((reslove)=>{\n              const img=new rowImage()\n              img.src=url\n              reslove(url)\n          })\n        })\n        await Promise.all(requestList)\n     }\n  }","import RequestList from './request'\nimport LogList from './log'\nlet request:RequestList|null=null\nlet log:LogList|null=null\n//这里工厂+单例，方便后期动态修改或添加配置\nexport function requestListFactory():RequestList{\n    if(!request){\n      return new RequestList()\n    }\n    return request\n}\nexport function logListFactory(options:any):LogList{\n   if(!log){\n    return new LogList(options)\n   }\n   return log\n}\n// 解耦工具类，将主类和队列类进行解耦\nexport class InterceptorIOCTool{\n  requestList:RequestList\n  logList:LogList\n  constructor(requestList:RequestList,logList:LogList){\n      this.requestList=requestList\n      this.logList=logList\n  }\n  createRequestInterceptor(){\n    const vm=this\n    return function(url:url){\n      if(vm.logList.isLogger(url)){\n        vm.logList.add(url.toString())\n        return true\n      }\n      vm.requestList.add(url.toString())\n      return false\n    }\n  }\n  createResponseInterceptor(options:Options){\n    const vm=this\n    return function(url:string | URL){\n      if(!vm.logList.isLogger(url)){\n        vm.requestList.delete(url.toString())\n      } else{\n        // 如果是log,直接返回，防止递归死循环\n        return false\n      }\n      if(vm.requestList.getLength()<=options.trigger){\n          vm.logList.requestLog()\n      }\n      return true\n    }\n  }\n}\n","// 默认配置对象\nconst defaultOptions={   \n    trigger:3,\n    log:/log.gif/\n}\n\nexport function mergeOptions(userOptions:Options){\n    // 目前直接合并，之后如果有数组，对象配置需要考虑扩展\n   return Object.assign(defaultOptions,userOptions)\n}","import {overrideImage} from './proxy';\nimport RequestHandler from './handler';\nimport {requestListFactory,logListFactory} from './queue/index'\nimport {InterceptorIOCTool} from './queue/index'\nimport {mergeOptions} from './options/default'\nimport RequestList from './queue/request';\nimport LogList from './queue/log';\nexport default class logScheduler {\n  options:Options;\n  requestHandler:RequestHandler;\n  requestList:RequestList;\n  logList:LogList;\n  interceptor:Interceptor;\n  constructor(options:any) {\n    this.options=mergeOptions(options)\n    this.initRequestQueue()\n    this.initInterceptor()\n    this.initObserver();\n  }\n  // 初始化图片劫持和请求观测\n  initObserver() {\n    overrideImage(this.interceptor.request)\n    this.requestHandler = new RequestHandler(this.interceptor);\n  }\n  // 初始化请求队列和打点队列\n  initRequestQueue(){\n      this.requestList=requestListFactory()\n      this.logList=logListFactory(this.options)\n  }\n  // 初始化拦截器\n  initInterceptor(){\n      const interceptorIOCTool=new InterceptorIOCTool(\n        this.requestList,this.logList\n      )\n      this.interceptor.request=interceptorIOCTool.createRequestInterceptor()\n      this.interceptor.response=interceptorIOCTool.createResponseInterceptor(this.options)\n  }\n}\n"],"names":["rowImage","tag","overrideImage","callback","width","height","img","target","prototype","receiver","value","RequestHandler","interceptor","__publicField","open","vm","method","url","async","user","password","entries","entry","BaseList","item","deletedItem","deletedIndex","setImageDomObserve","targetNode","observerOptions","RequestList","LogList","options","logReg","requestList","reslove","requestListFactory","logListFactory","InterceptorIOCTool","logList","defaultOptions","mergeOptions","userOptions","logScheduler","interceptorIOCTool"],"mappings":"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"}